version: '3.8'

services:

  mongo-setup:
    build:
      context: ./mongo-setup
    container_name: finance_mongo_setup
    hostname: mongo-setup
    networks:
      - finance_network
    environment:
      MONGO_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGODB_EXTRA_FLAGS: --quiet
      MONGO_INITDB_DATABASE: admin
    depends_on:
      mongo-config1:
        condition: service_healthy
      mongo-config2:
        condition: service_healthy
      mongo-config3:
        condition: service_healthy
      mongo-shard1:
        condition: service_healthy
      mongo-shard2:
        condition: service_healthy
      mongo-router:
        condition: service_healthy
    restart: "no"
    # Add DNS options to help with hostname resolution
    dns_search: .
    # Use a healthcheck to ensure MongoDB services are ready
    healthcheck:
      test: "ping -c 1 mongo-config1 && ping -c 1 mongo-config2 && ping -c 1 mongo-config3"
      interval: 5s
      timeout: 10s
      retries: 5
    # Execute initialization script with proper startup checks
    command: >
      sh -c "sleep 10 && ping -c 1 mongo-config1 && ping -c 1 mongo-config2 && ping -c 1 mongo-config3 && 
      ping -c 1 mongo-shard1 && ping -c 1 mongo-shard2 && ping -c 1 mongo-router && 
      python3 /mongo_init.py"
  # HDFS NameNode
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: finance_hdfs_namenode
    volumes:
      - hadoop_namenode:/hadoop/dfs/name
    environment:
      - CLUSTER_NAME=finance_hadoop
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - CORE_CONF_hadoop_http_staticuser_user=root
      - HDFS_CONF_dfs_replication=3
      - HDFS_CONF_dfs_permissions=false
    ports:
      - "9870:9870"
      - "8020:8020"
    networks:
      - finance_network
    restart: unless-stopped

  # HDFS DataNode 1
  datanode1:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: finance_hdfs_datanode1
    volumes:
      - hadoop_datanode1:/hadoop/dfs/data
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - HDFS_CONF_dfs_datanode_data_dir=/hadoop/dfs/data
      - SERVICE_PRECONDITION=namenode:9870
    depends_on:
      - namenode
    networks:
      - finance_network
    restart: unless-stopped

  # HDFS DataNode 2
  datanode2:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: finance_hdfs_datanode2
    volumes:
      - hadoop_datanode2:/hadoop/dfs/data
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - HDFS_CONF_dfs_datanode_data_dir=/hadoop/dfs/data
      - SERVICE_PRECONDITION=namenode:9870
    depends_on:
      - namenode
    networks:
      - finance_network
    restart: unless-stopped

  # HDFS DataNode 3
  datanode3:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: finance_hdfs_datanode3
    volumes:
      - hadoop_datanode3:/hadoop/dfs/data
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:8020
      - HDFS_CONF_dfs_datanode_data_dir=/hadoop/dfs/data
      - SERVICE_PRECONDITION=namenode:9870
    depends_on:
      - namenode
    networks:
      - finance_network
    restart: unless-stopped

  # MongoDB Config Servers
  mongo-config1:
    image: mongo:5.0
    container_name: finance_mongo_config1
    hostname: mongo-config1
    command: mongod --configsvr --replSet configrs --port 27017 --bind_ip_all
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGODB_REPLICA_SET_MODE: primary
      MONGODB_REPLICA_SET_NAME: configrs
      MONGODB_ADVERTISED_HOSTNAME: mongo-config1
    volumes:
      - mongo_config1_data:/data/db
    networks:
      - finance_network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping').ok" mongo-config1:27017/admin --username ${MONGO_ROOT_USERNAME} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  mongo-config2:
    image: mongo:5.0
    container_name: finance_mongo_config2
    hostname: mongo-config2
    command: mongod --configsvr --replSet configrs --port 27017 --bind_ip_all
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGODB_REPLICA_SET_MODE: secondary
      MONGODB_REPLICA_SET_NAME: configrs
      MONGODB_ADVERTISED_HOSTNAME: mongo-config2
      MONGODB_PRIMARY_HOST: mongo-config1
      MONGODB_PRIMARY_PORT_NUMBER: 27017
    volumes:
      - mongo_config2_data:/data/db
    networks:
      - finance_network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping').ok" mongo-config2:27017/admin --username ${MONGO_ROOT_USERNAME} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  mongo-config3:
    image: mongo:5.0
    container_name: finance_mongo_config3
    hostname: mongo-config3
    command: mongod --configsvr --replSet configrs --port 27017 --bind_ip_all
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGODB_REPLICA_SET_MODE: secondary
      MONGODB_REPLICA_SET_NAME: configrs
      MONGODB_ADVERTISED_HOSTNAME: mongo-config3
      MONGODB_PRIMARY_HOST: mongo-config1
      MONGODB_PRIMARY_PORT_NUMBER: 27017
    volumes:
      - mongo_config3_data:/data/db
    networks:
      - finance_network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping').ok" mongo-config3:27017/admin --username ${MONGO_ROOT_USERNAME} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # MongoDB Shards
  mongo-shard1:
    image: mongo:5.0
    container_name: finance_mongo_shard1
    hostname: mongo-shard1
    command: mongod --shardsvr --replSet shard1rs --port 27017 --bind_ip_all
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGODB_REPLICA_SET_MODE: primary
      MONGODB_REPLICA_SET_NAME: shard1rs
      MONGODB_ADVERTISED_HOSTNAME: mongo-shard1
    volumes:
      - mongo_shard1_data:/data/db
    networks:
      - finance_network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping').ok" mongo-shard1:27017/admin --username ${MONGO_ROOT_USERNAME} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  mongo-shard2:
    image: mongo:5.0
    container_name: finance_mongo_shard2
    hostname: mongo-shard2
    command: mongod --shardsvr --replSet shard2rs --port 27017 --bind_ip_all
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGODB_REPLICA_SET_MODE: primary
      MONGODB_REPLICA_SET_NAME: shard2rs
      MONGODB_ADVERTISED_HOSTNAME: mongo-shard2
    volumes:
      - mongo_shard2_data:/data/db
    networks:
      - finance_network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping').ok" mongo-shard2:27017/admin --username ${MONGO_ROOT_USERNAME} --password ${MONGO_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # MongoDB Router (mongos)
  mongo-router:
    image: mongo:5.0
    container_name: finance_mongo_router
    hostname: mongo-router
    command: mongos --configdb configrs/mongo-config1:27017,mongo-config2:27017,mongo-config3:27017 --port 27017 --bind_ip_all
    ports:
      - "27017:27017"
    environment:
      MONGO_ROUTER_CONFIGDB: configrs/mongo-config1:27017,mongo-config2:27017,mongo-config3:27017
    networks:
      - finance_network
    depends_on:
      - mongo-config1
      - mongo-config2
      - mongo-config3
      - mongo-shard1
      - mongo-shard2
    healthcheck:
      test: mongosh --quiet --eval "print('Connection check')" || echo 0
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped


  # Zookeeper Ensemble
  zookeeper1:
    image: confluentinc/cp-zookeeper:7.2.0
    hostname: zookeeper1
    container_name: finance_zookeeper1
    ports:
      - '2181:2181'
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_SERVERS: zookeeper1:2888:3888;zookeeper2:2888:3888;zookeeper3:2888:3888
    networks:
      - finance_network
    restart: unless-stopped

  zookeeper2:
    image: confluentinc/cp-zookeeper:7.2.0
    hostname: zookeeper2
    container_name: finance_zookeeper2
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SERVER_ID: 2
      ZOOKEEPER_SERVERS: zookeeper1:2888:3888;zookeeper2:2888:3888;zookeeper3:2888:3888
    networks:
      - finance_network
    restart: unless-stopped

  zookeeper3:
    image: confluentinc/cp-zookeeper:7.2.0
    hostname: zookeeper3
    container_name: finance_zookeeper3
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SERVER_ID: 3
      ZOOKEEPER_SERVERS: zookeeper1:2888:3888;zookeeper2:2888:3888;zookeeper3:2888:3888
    networks:
      - finance_network
    restart: unless-stopped

  # Kafka Broker 1
  kafka-broker1:
    image: confluentinc/cp-kafka:7.2.0
    hostname: kafka-broker1
    container_name: finance_kafka_broker1
    depends_on:
      - zookeeper1
      - zookeeper2
      - zookeeper3
    ports:
      - '9092:9092'
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper1:2181,zookeeper2:2181,zookeeper3:2181"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka-broker1:29092,PLAINTEXT_HOST://kafka-broker1:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker1:29092,PLAINTEXT_HOST://kafka-broker1:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - finance_network
    restart: unless-stopped

  # Kafka Broker 2
  kafka-broker2:
    image: confluentinc/cp-kafka:7.2.0
    hostname: kafka-broker2
    container_name: finance_kafka_broker2
    depends_on:
      - zookeeper1
      - zookeeper2
      - zookeeper3
    ports:
      - '9093:9093'
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper1:2181,zookeeper2:2181,zookeeper3:2181"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka-broker2:29093,PLAINTEXT_HOST://kafka-broker2:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker2:29093,PLAINTEXT_HOST://kafka-broker2:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - finance_network
    restart: unless-stopped

  # Kafka Broker 3
  kafka-broker3:
    image: confluentinc/cp-kafka:7.2.0
    hostname: kafka-broker3
    container_name: finance_kafka_broker3
    depends_on:
      - zookeeper1
      - zookeeper2
      - zookeeper3
    ports:
      - '9094:9094'
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper1:2181,zookeeper2:2181,zookeeper3:2181"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://kafka-broker3:29094,PLAINTEXT_HOST://kafka-broker3:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker3:29094,PLAINTEXT_HOST://kafka-broker3:9094
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - finance_network
    restart: unless-stopped

  # Spark Master
  spark-master:
    build:
      context: ./docker
      dockerfile: spark.Dockerfile
    container_name: finance_spark_master
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_CONF_DIR=/spark/conf
    ports:
      - "8080:8080"
      - "7077:7077"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./spark-conf:/spark/conf
    networks:
      - finance_network
    restart: unless-stopped

  # Spark Worker 1
  spark-worker1:
    build:
      context: ./docker
      dockerfile: spark.Dockerfile
    container_name: finance_spark_worker1
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2g
      - SPARK_WORKER_WEBUI_PORT=8081
      - SPARK_CONF_DIR=/spark/conf
    ports:
      - "8081:8081"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./spark-conf:/spark/conf
    networks:
      - finance_network
    depends_on:
      - spark-master
    restart: unless-stopped

  # Spark Worker 2
  spark-worker2:
    build:
      context: ./docker
      dockerfile: spark.Dockerfile
    container_name: finance_spark_worker2
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2g
      - SPARK_WORKER_WEBUI_PORT=8082
      - SPARK_CONF_DIR=/spark/conf
    ports:
      - "8082:8081"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./spark-conf:/spark/conf
    networks:
      - finance_network
    depends_on:
      - spark-master
    restart: unless-stopped

  # Spark Worker 3
  spark-worker3:
    build:
      context: ./docker
      dockerfile: spark.Dockerfile
    container_name: finance_spark_worker3
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2g
      - SPARK_WORKER_WEBUI_PORT=8083
      - SPARK_CONF_DIR=/spark/conf
    ports:
      - "8083:8081"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./spark-conf:/spark/conf
    networks:
      - finance_network
    depends_on:
      - spark-master
    restart: unless-stopped

  # Elasticsearch Cluster
  elasticsearch-master:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.3.3
    container_name: finance_elasticsearch_master
    environment:
      - node.name=master
      - cluster.name=finance-es-cluster
      - discovery.seed_hosts=elasticsearch-data1,elasticsearch-data2,elasticsearch-data3
      - cluster.initial_master_nodes=master
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_master_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - finance_network
    restart: unless-stopped

  elasticsearch-data1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.3.3
    container_name: finance_elasticsearch_data1
    environment:
      - node.name=data1
      - cluster.name=finance-es-cluster
      - discovery.seed_hosts=elasticsearch-master,elasticsearch-data2,elasticsearch-data3
      - cluster.initial_master_nodes=master
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - bootstrap.memory_lock=true
      - node.roles=["data", "ingest"]
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_data1_data:/usr/share/elasticsearch/data
    networks:
      - finance_network
    depends_on:
      - elasticsearch-master
    restart: unless-stopped

  elasticsearch-data2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.3.3
    container_name: finance_elasticsearch_data2
    environment:
      - node.name=data2
      - cluster.name=finance-es-cluster
      - discovery.seed_hosts=elasticsearch-master,elasticsearch-data1,elasticsearch-data3
      - cluster.initial_master_nodes=master
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - bootstrap.memory_lock=true
      - node.roles=["data", "ingest"]
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_data2_data:/usr/share/elasticsearch/data
    networks:
      - finance_network
    depends_on:
      - elasticsearch-master
    restart: unless-stopped

  elasticsearch-data3:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.3.3
    container_name: finance_elasticsearch_data3
    environment:
      - node.name=data3
      - cluster.name=finance-es-cluster
      - discovery.seed_hosts=elasticsearch-master,elasticsearch-data1,elasticsearch-data2
      - cluster.initial_master_nodes=master
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - bootstrap.memory_lock=true
      - node.roles=["data", "ingest"]
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_data3_data:/usr/share/elasticsearch/data
    networks:
      - finance_network
    depends_on:
      - elasticsearch-master
    restart: unless-stopped

  # Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.3.3
    container_name: finance_kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch-master:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    ports:
      - "${KIBANA_PORT}:5601"
    networks:
      - finance_network
    depends_on:
      - elasticsearch-master
    restart: unless-stopped

  # Crawler Service
  crawler:
    build:
      context: ./crawler
      dockerfile: Dockerfile
    container_name: finance_crawler
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./configs:/app/configs
    env_file:
      - .env
    networks:
      - finance_network
    depends_on:
      - mongo-router
      - kafka-broker1
      - kafka-broker2
      - kafka-broker3

  # Kafka Consumer Service
  kafka-consumer:
    build:
      context: ./kafka-consumer
      dockerfile: Dockerfile
    container_name: finance_kafka_consumer
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    env_file:
      - .env
    networks:
      - finance_network
    depends_on:
      - kafka-broker1
      - kafka-broker2
      - kafka-broker3
      - mongo-router

  # ETL Service
  etl:
    build:
      context: ./spark-job
      dockerfile: Dockerfile
    container_name: finance_etl
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./configs:/app/configs
    env_file:
      - .env
    environment:
      - SPARK_MASTER=spark://spark-master:7077
      - HADOOP_CONF_DIR=/etc/hadoop/conf
      - YARN_CONF_DIR=/etc/hadoop/conf
    networks:
      - finance_network
    depends_on:
      - spark-master
      - spark-worker1
      - spark-worker2
      - spark-worker3
      - namenode
      - datanode1
      - datanode2
      - datanode3
      - mongo-router

  # Model Training Service
  trainer:
    build:
      context: ./trainer
      dockerfile: Dockerfile
    container_name: finance_trainer
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./configs:/app/configs
    env_file:
      - .env
    environment:
      - SPARK_MASTER=spark://spark-master:7077
      - HADOOP_CONF_DIR=/etc/hadoop/conf
      - YARN_CONF_DIR=/etc/hadoop/conf
      - TF_CONFIG=${TF_CONFIG:-'{"cluster":{"worker":["trainer:2222","spark-worker1:2223","spark-worker2:2224"]},"task":{"type":"worker","index":0}}'}
    networks:
      - finance_network
    depends_on:
      - spark-master
      - spark-worker1
      - spark-worker2
      - spark-worker3
      - namenode
      - datanode1
      - datanode2
      - datanode3

  # Model Inference Service
  inference:
    build:
      context: ./inference
      dockerfile: Dockerfile
    container_name: finance_inference
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./configs:/app/configs
    env_file:
      - .env
    environment:
      - HADOOP_CONF_DIR=/etc/hadoop/conf
      - YARN_CONF_DIR=/etc/hadoop/conf
    networks:
      - finance_network
    depends_on:
      - elasticsearch-master
      - mongo-router
      - namenode

  # Scheduler Service
  scheduler:
    build:
      context: ./docker
      dockerfile: scheduler.Dockerfile
    container_name: finance_scheduler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/app/data
      - ./logs:/app/logs
      - ./configs:/app/configs
    env_file:
      - .env
    networks:
      - finance_network
    depends_on:
      - mongo-router
      - spark-master
      - elasticsearch-master
      - namenode
    restart: unless-stopped

networks:
  finance_network:
    name: ${NETWORK_NAME}

volumes:
  # MongoDB volumes
  mongo_config1_data:
  mongo_config2_data:
  mongo_config3_data:
  mongo_shard1_data:
  mongo_shard2_data:
  
  # HDFS volumes
  hadoop_namenode:
  hadoop_datanode1:
  hadoop_datanode2:
  hadoop_datanode3:
  
  # Elasticsearch volumes
  es_master_data:
  es_data1_data:
  es_data2_data:
  es_data3_data:
